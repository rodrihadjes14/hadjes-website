<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Fonts: Exo 2 (headlines) + Open Sans (body) -->
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@500;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
  

<body class="sidebar-layout"> 
  
  
  <header>
  <div class="header-logo-and-search">
      <a href="index.html" class="brand-button">Hadjes Propiedades</a>
    
    <div class="header-right">
    <div class="filter-bar">
      <div class="filter-options">
      <label><input type="radio" name="operation" value="venta"> Venta</label>
      <label><input type="radio" name="operation" value="alquiler"> Alquiler</label>
      <label><input type="radio" name="operation" value="temporal"> Alquiler Temporal</label>
    </div>

    <select class="property-type" name="type">
      <option value="">Propiedad</option>
      <option value="casa">Casa</option>
      <option value="departamento">Departamento</option>
      <option value="edificio">Edificio</option>
      <option value="cochera">Cochera</option>
      <option value="local">Local</option>
      <option value="oficina">Oficina</option>
      <option value="campo">Campo</option>
      <option value="lote">Lote</option>
    </select>


    <input name="q" type="text" class="search-input" placeholder="Ubicación / Location, keyword..." /> 
    <button id="search-button" class="search-button">Buscar</button>
  </div>
      <nav class="header-links" aria-label="Páginas del sitio">
        <a href="who-we-are.html">Quiénes Somos</a>
        <a href="contact.html">Hacé tu consulta</a>
      </nav>
    </div>
  </div>

  </header>
  
  <!--FILTROS BUTTON!!!!!!-->
  
  <button id="open-sidebar" class="mobile-toggle-button">☰ Filtros</button>

    

<!-- SIDEBAR -->
  
  <div class="page-layout">
  
  <div id="sidebar-wrapper">
  <aside class="sidebar-filters">
    <form id="sidebar-form">
      <h3>Filtrar Propiedades</h3>
    
      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Operación</button>
        <div class= "dropdown-content input-group operation-group">
        <label><input type="radio" name="operation" value="venta"> Venta</label>
        <label><input type="radio" name="operation" value="alquiler"> Alquiler</label>
        <label><input type="radio" name="operation" value="temporal"> Temporal</label>
       </div>
      </div>

      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Tipo de Propiedad</button>
        <div class= "dropdown-content input-group operation-group">
        <label><input type="checkbox" name="type" value="casa"> Casa</label>
        <label><input type="checkbox" name="type" value="departamento"> Departamento</label>
        <label><input type="checkbox" name="type" value="oficina"> Oficina</label>
        <label><input type="checkbox" name="type" value="local"> Local</label>
        </div>
      </div>


      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Ubicación</button>
        <div class= "dropdown-content input-group operation-group">
        <label><input type="checkbox" name="location" value="belgrano"> Belgrano</label>
        <label><input type="checkbox" name="location" value="palermo"> Palermo</label>
        <label><input type="checkbox" name="location" value="recoleta"> Recoleta</label>
       </div>
      </div>


      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Ambientes</button>
        <div class= "dropdown-content input-group operation-group">
        <label><input type="checkbox" name="ambientes" value="1"> 1</label>
        <label><input type="checkbox" name="ambientes" value="2"> 2</label>
        <label><input type="checkbox" name="ambientes" value="3"> 3</label>
        <label><input type="checkbox" name="ambientes" value="4"> 4+</label>
       </div>
      </div>


      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Precio Mínimo</button>
        <div class="dropdown-content input-group operation group">
         <label for="priceMin">Precio Mínimo:</label>
         <input id="priceMin" type="number" name="priceMin" />
        </div>
      </div>
      
      <div class="dropdown-filter">
        <button type="button" class="dropdown-toggle">Precio Máximo</button>
        <div class="dropdown-content input group operation group">
          <label for="priceMax">Precio Máximo:</label>
          <input id="priceMax" type="number" name="priceMax" />
        </div>
      </div>
      

      <button id="sidebar-search-button" type="submit">Filtrar</button>
    </form>
  </aside>
</div>
    
  <!--SEARCH RESULTS-->
    
  <section id="properties" class="properties">
  <h2>Resultados Relacionados a Tu Busqueda</h2>
  <div id="search-listings" class="search-grid">Loading results…</div>
  <nav id="pagination" class="pagination" aria-label="Resultados paginados"></nav>
</section>
    
    
</div>
    

  <div id="footer-root"></div>

  
  
  
<!--SCRIPT-->
  
<script>
  
async function fetchListings() {
  // 1) Fetch all listings from your backend
  const res = await fetch('https://hadjes-backend.onrender.com/listings');
  const listings = await res.json();

  // 2) Read filters from URL (keeps your current behavior)
  const params = new URLSearchParams(window.location.search);
  const types = params.get('type')?.split(',') || [];
  const operation = params.get('operation');
  const locations = params.get('location')?.split(',') || [];
  const ambientes = params.get('ambientes')?.split(',') || [];
  const priceMin = parseFloat(params.get('priceMin'));
  const priceMax = parseFloat(params.get('priceMax'));
  const keyword = (params.get('q') || '').toLowerCase();

  // 3) Apply filters
  const filtered = listings.filter(listing => {
    const matchOperation = !operation || listing.operation === operation;
    const matchType = types.length === 0 || types.includes(listing.type);
    const matchLocation = locations.length === 0 || locations.includes(listing.location);
    const matchAmbientes = ambientes.length === 0 || ambientes.includes(String(listing.ambientes));
    const matchPriceMin = isNaN(priceMin) || listing.price >= priceMin;
    const matchPriceMax = isNaN(priceMax) || listing.price <= priceMax;
    const matchKeyword =
      !keyword ||
      (listing.title && listing.title.toLowerCase().includes(keyword)) ||
      (listing.description && listing.description.toLowerCase().includes(keyword)) ||
      (listing.location && listing.location.toLowerCase().includes(keyword));

    return (
      matchOperation &&
      matchType &&
      matchLocation &&
      matchAmbientes &&
      matchPriceMin &&
      matchPriceMax &&
      matchKeyword
    );
  });

  // 4) Hook containers (grid + pagination)
  const grid = document.getElementById('search-listings');
  const pager = document.getElementById('pagination');
  grid.innerHTML = '';
  pager.innerHTML = '';

  // 5) Empty state
  if (filtered.length === 0) {
    grid.innerHTML = '<p>No properties match your filters.</p>';
    return;
  }

  // 6) Pagination state
  const PAGE_SIZE = 24; // 3 columns × 8 rows
  let currentPage = 1;
  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);

  // 7) Render current page
  function renderPage(page) {
    currentPage = page;
    grid.innerHTML = '';

    const start = (page - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const slice = filtered.slice(start, end);

    slice.forEach(listing => {
      // Each item is a child of the grid; .search-grid CSS makes it fit the column
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <a href="listing.html?slug=${listing.slug || listing._id}" style="text-decoration: none; color: inherit;">
          <div class="listing-box">
            ${listing.imageUrl ? `<img src="${listing.imageUrl}" alt="${listing.title || ''}" />` : ''}
            <h3>${listing.title || 'Untitled listing'}</h3>
            ${listing.description ? `<p>${listing.description}</p>` : ''}
            ${typeof listing.price !== 'undefined' ? `<p><strong>Price:</strong> $${listing.price}</p>` : ''}
            ${listing.location ? `<p><strong>Location:</strong> ${listing.location}</p>` : ''}
          </div>
        </a>
      `;
      grid.appendChild(wrapper);
    });

    renderPagination();
    // Optional: jump to top after page change
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // 8) Render pagination controls
  function renderPagination() {
    pager.innerHTML = '';

    const prev = document.createElement('button');
    prev.textContent = 'Prev';
    prev.disabled = currentPage === 1;
    prev.addEventListener('click', () => renderPage(currentPage - 1));
    pager.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
      btn.addEventListener('click', () => renderPage(i));
      pager.appendChild(btn);
    }

    const next = document.createElement('button');
    next.textContent = 'Next';
    next.disabled = currentPage === totalPages;
    next.addEventListener('click', () => renderPage(currentPage + 1));
    pager.appendChild(next);
  }

  // 9) Initial render
  renderPage(1);
}


  
  
  
  // FETCHING A SINGLE LISTING
  
 async function fetchSingleListing(slug) {
  try {
    // 1) Grab containers and guard early
    const container = document.getElementById('search-listings');
    if (!container) {
      console.error('Single view container not found');
      return;
    }
    const pager = document.getElementById('pagination');

    // 2) Prepare the container for single view
    container.innerHTML = '';
    container.classList.remove('search-grid');
    container.classList.add('single-view');
    if (pager) pager.style.display = 'none';

    // 3) Quick loader feedback
    container.innerHTML = '<p>Loading listing…</p>';

    const res = await fetch('https://hadjes-backend.onrender.com/listings');
    const listings = await res.json();

    const listing = listings.find(item => item.slug === slug || item._id === slug);


    if (!listing) {
      container.innerHTML = '<p>❌ Listing not found.</p>';
      return;
    }

    const div = document.createElement('div');
    div.className = 'listing-detail';
    div.innerHTML = `
      <h2>${listing.title}</h2>
      <img src="${listing.imageUrl}" width="400" />
      <p>${listing.description}</p>
      <p><strong>Price:</strong> $${listing.price}</p>
      <p><strong>Location:</strong> ${listing.location}</p>
      <p><strong>Type:</strong> ${listing.type}</p>
      <p><strong>Operation:</strong> ${listing.operation}</p>
    `;
    
    container.innerHTML = ''; 
    container.appendChild(div);
  } catch (err) {
    console.error('Error loading single listing:', err);
  }
}
  // SIDEBAR FUNCTIONS
  
  document.addEventListener('DOMContentLoaded', () => {
  const sidebarBtn = document.getElementById('sidebar-search-button'); 
  if (sidebarBtn) {
    sidebarBtn.addEventListener('click', function (e) {
      e.preventDefault();

      const params = new URLSearchParams();

      // Get checked types
      const types = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(i => i.value);
      if (types.length) params.set('type', types.join(','));

      // Operation
      const operation = document.querySelector('input[name="operation"]:checked')?.value;
      if (operation) params.set('operation', operation);

      // Locations
      const locations = Array.from(document.querySelectorAll('input[name="location"]:checked')).map(i => i.value);
      if (locations.length) params.set('location', locations.join(','));

      // Ambientes
      const ambientes = Array.from(document.querySelectorAll('input[name="ambientes"]:checked')).map(i => i.value);
      if (ambientes.length) params.set('ambientes', ambientes.join(','));

      // Price min/max
      const priceMin = document.querySelector('input[name="priceMin"]')?.value;
      const priceMax = document.querySelector('input[name="priceMax"]')?.value;
      if (priceMin) params.set('priceMin', priceMin);
      if (priceMax) params.set('priceMax', priceMax);

      // Redirect to filtered URL
      window.location.href = `listing.html?${params.toString()}`;
    });
  }
});

  //SIDEBAR FUNCTIONS
  
    document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('search-button');
    if (btn) {
      btn.addEventListener('click', function (e) {
        e.preventDefault();

        const params = new URLSearchParams();

        // ✅ Keyword input
        const q = document.querySelector('input[name="q"]')?.value;
        if (q) params.set('q', q);

        // ✅ Operation radio
        const operation = document.querySelector('input[name="operation"]:checked')?.value;
        if (operation) params.set('operation', operation);

        // ✅ Property type dropdown
        const type = document.querySelector('select[name="type"]')?.value;
        if (type) params.set('type', type);

        // 🚀 Redirect with all selected filters
        window.location.href = `listing.html?${params.toString()}`;
      });
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    // Read URL params safely
    const params = new URLSearchParams(window.location.search);
    const slug = params.get('slug'); // <-- NOW slug is defined

    // If you have a single-listing page behavior, use it when slug exists.
    if (slug && typeof fetchSingleListing === 'function') {
      fetchSingleListing(slug);
    } else {
      // Default: load the paginated listings grid
      fetchListings();
    }
  });
</script>



  
<script>
  
  // TOGGLE RESPONSIVE MOBILE SIDEBAR OPERATIONS //
  
  document.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('open-sidebar');
    const sidebar = document.getElementById('sidebar-wrapper');

    openBtn?.addEventListener('click', () => {
      sidebar.classList.toggle('show-mobile');
    });

    // Optional: Close sidebar if clicked outside (mobile only)
    document.addEventListener('click', (e) => {
      if (
        window.innerWidth <= 768 &&
        sidebar.classList.contains('show-mobile') &&
        !sidebar.contains(e.target) &&
        e.target !== openBtn
      ) {
        sidebar.classList.remove('show-mobile');
      }
    });

    // Optional: Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        sidebar.classList.remove('show-mobile');
      }
    });
  });
</script>

  
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.dropdown-toggle').forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault(); // 👈 important fix

        const content = button.nextElementSibling;
        const isOpen = content.style.display === 'block';

        document.querySelectorAll('.dropdown-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.dropdown-toggle').forEach(b => b.classList.remove('open'));

        content.style.display = isOpen ? 'none' : 'block';
        button.classList.toggle('open', !isOpen);
      });
    });
  });
</script>

<script src="/js/footer-loader.js" defer></script>

</body>
</html>
